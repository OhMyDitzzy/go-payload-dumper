name: Termux Specific Build

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  termux-build:
    name: Build for Termux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Protocol Buffers Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install protoc-gen-go
        run: go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

      - name: Generate Protocol Buffers
        run: protoc --go_out=. --go_opt=paths=source_relative protos/update_metadata.proto

      - name: Download dependencies
        run: go mod download

      - name: Build for Termux ARM64
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -tags 'osusergo netgo static_build' -o go-payload-dumper-termux-arm64 ./cmd/dumper
          tar -czf go-payload-dumper-termux-arm64.tar.gz go-payload-dumper-termux-arm64
          sha256sum go-payload-dumper-termux-arm64.tar.gz > go-payload-dumper-termux-arm64.tar.gz.sha256

      - name: Build for Termux ARM
        env:
          GOOS: linux
          GOARCH: arm
          GOARM: 7
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -tags 'osusergo netgo static_build' -o go-payload-dumper-termux-armv7 ./cmd/dumper
          tar -czf go-payload-dumper-termux-armv7.tar.gz go-payload-dumper-termux-armv7
          sha256sum go-payload-dumper-termux-armv7.tar.gz > go-payload-dumper-termux-armv7.tar.gz.sha256

      - name: Create Termux Installation Script
        run: |
          cat > termux-install.sh << 'EOF'
          #!/data/data/com.termux/files/usr/bin/bash
          
          ARCH=$(uname -m)
          
          if [ "$ARCH" = "aarch64" ]; then
              BINARY="go-payload-dumper-termux-arm64"
              echo "✓ Detected ARM64 architecture"
          elif [ "$ARCH" = "armv7l" ] || [ "$ARCH" = "armv8l" ]; then
              BINARY="go-payload-dumper-termux-armv7"
              echo "✓ Detected ARMv7 architecture"
          else
              echo "✗ Unsupported architecture: $ARCH"
              exit 1
          fi
          
          # Install dependencies
          echo ""
          echo "Installing dependencies..."
          pkg update -y
          pkg install -y xz-utils wget
          
          # Download binary
          echo ""
          echo "Downloading Go Payload Dumper..."
          RELEASE_URL="https://github.com/OhMyDitzzy/go-payload-dumper/releases/latest/download/${BINARY}.tar.gz"
          
          wget -q --show-progress "$RELEASE_URL" -O /tmp/${BINARY}.tar.gz
          
          if [ $? -ne 0 ]; then
              echo "✗ Failed to download binary"
              exit 1
          fi
          
          # Extract and install
          echo ""
          echo "Installing..."
          tar -xzf /tmp/${BINARY}.tar.gz -C /tmp/
          mv /tmp/${BINARY} $PREFIX/bin/go-payload-dumper
          chmod +x $PREFIX/bin/go-payload-dumper
          rm /tmp/${BINARY}.tar.gz
          
          echo ""
          echo "✅ Installation complete!"
          echo ""
          echo "Usage: go-payload-dumper -payload <file>"
          echo "Help:  go-payload-dumper -h"
          EOF
          chmod +x termux-install.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: termux-builds
          path: |
            go-payload-dumper-termux-*.tar.gz
            go-payload-dumper-termux-*.sha256
            termux-install.sh
          retention-days: 7

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            go-payload-dumper-termux-*.tar.gz
            go-payload-dumper-termux-*.sha256
            termux-install.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}